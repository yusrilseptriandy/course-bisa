// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  admin
  teacher
  student
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  CANCELLED
}

enum CourseStatus {
  DRAFT
  READY
  PUBLISHED
}

enum VideoStatus {
  PROCESSING
  READY
  FAILED
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          Role      @default(student)
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?
  sessions      Session[]
  accounts      Account[]

  courses   Course[]
  comments  Comment[]
  likes     Like[]
  purchases Purchase[]

  @@unique([email])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Jwks {
  id         String    @id
  publicKey  String
  privateKey String
  createdAt  DateTime
  expiresAt  DateTime?

  @@map("jwks")
}

model Category {
  id      String   @id @default(uuid())
  name    String   @unique
  slug    String   @unique
  courses Course[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Course {
  id              String    @id @default(uuid())
  name            String
  desc            String?
  thumbnail       String?
  price           Int?
  durationSeconds Int?      @default(0)
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  isPublish       Boolean? @default(false)
  courseStatus    CourseStatus @default(DRAFT)

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Restrict)

  muxAssetId    String?     @unique
  muxPlaybackId String?     @unique
  muxUploadId   String?
  videoStatus   VideoStatus @default(PROCESSING)

  comments    Comment[]
  likes       Like[]
  purchases   Purchase[]
  attachments Attachment[]

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([isDeleted])
}

model Comment {
  id      String @id @default(uuid())
  content String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Restrict)

  parentId String?
  parent   Comment?  @relation("Reply", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("Reply")

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())

  @@index([courseId])
  @@index([userId])
}

model Like {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([courseId])
}

model Purchase {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Restrict)

  amount   Int
  currency String @default("IDR")

  status PaymentStatus @default(PENDING)

  externalId String?   @unique
  paymentUrl String?
  paidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([status])
  @@index([courseId])
  @@index([userId])
}

model Attachment {
  id   String @id @default(uuid())
  url  String
  name String

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}
